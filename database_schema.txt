
-- This schema is idempotent, meaning it can be run multiple times without causing errors.
-- It will create tables if they don't exist and add missing columns/constraints if needed.

-------------------------------------------
--              TABLES                   --
-------------------------------------------

-- Employees table
CREATE TABLE IF NOT EXISTS employees (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);
DO $$ BEGIN
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS employee_id varchar(50) NOT NULL UNIQUE;
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS full_name_ar varchar(255) NOT NULL;
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS full_name_en varchar(255);
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS job_title varchar(255) NOT NULL;
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS department varchar(255) NOT NULL;
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS center varchar(255);
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS phone_direct varchar(50);
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS email varchar(255);
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS national_id varchar(50);
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS nationality varchar(100);
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS gender varchar(20);
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS date_of_birth date;
  ALTER TABLE employees ADD COLUMN IF NOT EXISTS classification_id varchar(50);
END $$;

-- Office contacts table
CREATE TABLE IF NOT EXISTS office_contacts (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);
DO $$ BEGIN
  ALTER TABLE office_contacts ADD COLUMN IF NOT EXISTS name varchar(255) NOT NULL UNIQUE;
  ALTER TABLE office_contacts ADD COLUMN IF NOT EXISTS extension varchar(20) NOT NULL;
  ALTER TABLE office_contacts ADD COLUMN IF NOT EXISTS location varchar(255);
  ALTER TABLE office_contacts ADD COLUMN IF NOT EXISTS email varchar(255);
END $$;

-- Tasks table
CREATE TABLE IF NOT EXISTS tasks (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);
DO $$ BEGIN
  ALTER TABLE tasks ADD COLUMN IF NOT EXISTS title text NOT NULL;
  ALTER TABLE tasks ADD COLUMN IF NOT EXISTS description text;
  ALTER TABLE tasks ADD COLUMN IF NOT EXISTS due_date date;
  ALTER TABLE tasks ADD COLUMN IF NOT EXISTS is_completed boolean NOT NULL DEFAULT false;
END $$;

-- Transactions table
CREATE TABLE IF NOT EXISTS transactions (
  id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);
DO $$ BEGIN
  ALTER TABLE transactions ADD COLUMN IF NOT EXISTS transaction_number text NOT NULL UNIQUE;
  ALTER TABLE transactions ADD COLUMN IF NOT EXISTS subject text NOT NULL;
  ALTER TABLE transactions ADD COLUMN IF NOT EXISTS type text NOT NULL;
  ALTER TABLE transactions ADD COLUMN IF NOT EXISTS platform text NOT NULL;
  ALTER TABLE transactions ADD COLUMN IF NOT EXISTS status text NOT NULL;
  ALTER TABLE transactions ADD COLUMN IF NOT EXISTS date date NOT NULL;
  ALTER TABLE transactions ADD COLUMN IF NOT EXISTS description text;
  ALTER TABLE transactions ADD COLUMN IF NOT EXISTS attachment jsonb;
  ALTER TABLE transactions ADD COLUMN IF NOT EXISTS linked_employee_id bigint;
  ALTER TABLE transactions ADD COLUMN IF NOT EXISTS linked_office_contact_id bigint;
END $$;

-------------------------------------------
--         NEW RBAC TABLES             --
-------------------------------------------

CREATE TABLE IF NOT EXISTS roles (
  role_id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  role_name varchar(50) NOT NULL UNIQUE,
  description text
);

CREATE TABLE IF NOT EXISTS users (
  user_id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  username varchar(50) NOT NULL UNIQUE,
  password text NOT NULL,
  full_name varchar(100) NOT NULL,
  role_id bigint,
  is_active boolean NOT NULL DEFAULT true,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

CREATE TABLE IF NOT EXISTS permissions (
  permission_id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  permission_name varchar(100) NOT NULL UNIQUE,
  description text
);

CREATE TABLE IF NOT EXISTS role_permissions (
  role_id bigint NOT NULL,
  permission_id bigint NOT NULL,
  PRIMARY KEY (role_id, permission_id)
);

-------------------------------------------
--   FOREIGN KEY CONSTRAINTS             --
-------------------------------------------
DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'transactions_linked_employee_id_fkey') THEN
    ALTER TABLE transactions ADD CONSTRAINT transactions_linked_employee_id_fkey FOREIGN KEY (linked_employee_id) REFERENCES employees(id) ON DELETE SET NULL;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'transactions_linked_office_contact_id_fkey') THEN
    ALTER TABLE transactions ADD CONSTRAINT transactions_linked_office_contact_id_fkey FOREIGN KEY (linked_office_contact_id) REFERENCES office_contacts(id) ON DELETE SET NULL;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'users_role_id_fkey') THEN
    ALTER TABLE users ADD CONSTRAINT users_role_id_fkey FOREIGN KEY (role_id) REFERENCES roles(role_id) ON DELETE RESTRICT;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'role_permissions_role_id_fkey') THEN
    ALTER TABLE role_permissions ADD CONSTRAINT role_permissions_role_id_fkey FOREIGN KEY (role_id) REFERENCES roles(role_id) ON DELETE CASCADE;
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'role_permissions_permission_id_fkey') THEN
    ALTER TABLE role_permissions ADD CONSTRAINT role_permissions_permission_id_fkey FOREIGN KEY (permission_id) REFERENCES permissions(permission_id) ON DELETE CASCADE;
  END IF;
END $$;

-------------------------------------------
--        ROW LEVEL SECURITY (RLS)       --
-------------------------------------------
ALTER TABLE employees ENABLE ROW LEVEL SECURITY;
ALTER TABLE office_contacts ENABLE ROW LEVEL SECURITY;
ALTER TABLE tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE permissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE role_permissions ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Enable public read access" ON employees;
CREATE POLICY "Enable public read access" ON employees FOR SELECT USING (true);
DROP POLICY IF EXISTS "Enable public read access" ON office_contacts;
CREATE POLICY "Enable public read access" ON office_contacts FOR SELECT USING (true);
DROP POLICY IF EXISTS "Enable public read access" ON tasks;
CREATE POLICY "Enable public read access" ON tasks FOR SELECT USING (true);
DROP POLICY IF EXISTS "Enable public read access" ON transactions;
CREATE POLICY "Enable public read access" ON transactions FOR SELECT USING (true);
DROP POLICY IF EXISTS "Enable public read access" ON users;
CREATE POLICY "Enable public read access" ON users FOR SELECT USING (true);
DROP POLICY IF EXISTS "Enable public read access" ON roles;
CREATE POLICY "Enable public read access" ON roles FOR SELECT USING (true);
DROP POLICY IF EXISTS "Enable public read access" ON permissions;
CREATE POLICY "Enable public read access" ON permissions FOR SELECT USING (true);
DROP POLICY IF EXISTS "Enable public read access" ON role_permissions;
CREATE POLICY "Enable public read access" ON role_permissions FOR SELECT USING (true);

-- Allow all operations for authenticated users (for this demo app).
-- In a real app, you would restrict this based on user roles or IDs.
DROP POLICY IF EXISTS "Allow all for authenticated users" ON employees;
CREATE POLICY "Allow all for authenticated users" ON employees FOR ALL USING (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow all for authenticated users" ON office_contacts;
CREATE POLICY "Allow all for authenticated users" ON office_contacts FOR ALL USING (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow all for authenticated users" ON tasks;
CREATE POLICY "Allow all for authenticated users" ON tasks FOR ALL USING (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow all for authenticated users" ON transactions;
CREATE POLICY "Allow all for authenticated users" ON transactions FOR ALL USING (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow all for authenticated users" ON users;
CREATE POLICY "Allow all for authenticated users" ON users FOR ALL USING (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow all for authenticated users" ON roles;
CREATE POLICY "Allow all for authenticated users" ON roles FOR ALL USING (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow all for authenticated users" ON permissions;
CREATE POLICY "Allow all for authenticated users" ON permissions FOR ALL USING (auth.role() = 'authenticated');
DROP POLICY IF EXISTS "Allow all for authenticated users" ON role_permissions;
CREATE POLICY "Allow all for authenticated users" ON role_permissions FOR ALL USING (auth.role() = 'authenticated');

-------------------------------------------
--           SEEDING DATA                --
-------------------------------------------
DO $$
DECLARE
  admin_role_id bigint;
  data_entry_role_id bigint;
  viewer_role_id bigint;
BEGIN
  -- 1. Seed Roles
  INSERT INTO roles (role_name, description) VALUES
  ('Admin', 'Administrator with full system access'),
  ('Data Entry', 'Can add and edit most records'),
  ('Viewer', 'Can only view data')
  ON CONFLICT (role_name) DO NOTHING;

  SELECT role_id INTO admin_role_id FROM roles WHERE role_name = 'Admin';
  SELECT role_id INTO data_entry_role_id FROM roles WHERE role_name = 'Data Entry';
  SELECT role_id INTO viewer_role_id FROM roles WHERE role_name = 'Viewer';

  -- 2. Seed Permissions
  INSERT INTO permissions (permission_name, description) VALUES
  ('manage_users', 'Can add, edit, and deactivate users'),
  ('edit_employees', 'Can add and edit employee records'),
  ('delete_employees', 'Can delete employee records'),
  ('import_export_employees', 'Can import and export employee data'),
  ('edit_contacts', 'Can add and edit office contacts'),
  ('delete_contacts', 'Can delete office contacts'),
  ('import_export_contacts', 'Can import and export office contacts'),
  ('edit_tasks', 'Can edit any task'),
  ('delete_tasks', 'Can delete any task'),
  ('edit_transactions', 'Can edit any transaction'),
  ('delete_transactions', 'Can delete any transaction'),
  ('add_task', 'Can add a new task'),
  ('add_transaction', 'Can add a new transaction')
  ON CONFLICT (permission_name) DO NOTHING;

  -- 3. Seed Role_Permissions (clear existing before seeding)
  DELETE FROM role_permissions;

  -- Admin permissions (all)
  INSERT INTO role_permissions (role_id, permission_id)
  SELECT admin_role_id, p.permission_id FROM permissions p;

  -- Data Entry permissions
  INSERT INTO role_permissions (role_id, permission_id)
  SELECT data_entry_role_id, p.permission_id
  FROM permissions p
  WHERE p.permission_name IN (
    'edit_employees', 'import_export_employees',
    'edit_contacts', 'import_export_contacts',
    'edit_tasks', 'delete_tasks',
    'edit_transactions', 'delete_transactions',
    'add_task', 'add_transaction'
  );

  -- Viewer has no insert/edit/delete permissions by default.

  -- 4. Seed default Admin User if no users exist
  IF NOT EXISTS (SELECT 1 FROM users) THEN
    INSERT INTO users (username, password, full_name, role_id)
    VALUES ('admin', 'admin', 'Admin User', admin_role_id);
  END IF;

END;
$$;
